name: Daily PM Discovery & Re-scan Pipeline

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      skip_scrape:
        description: 'Skip new PM scraping (only relevant on Mondays)'
        type: boolean
        default: false
      skip_rescan:
        description: 'Skip chunk re-scan of existing domains'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium && playwright install-deps chromium

      - name: Run daily pipeline
        id: pipeline
        continue-on-error: true
        run: |
          FLAGS=""
          if [ "${{ github.event.inputs.skip_scrape }}" = "true" ]; then
            FLAGS="$FLAGS --skip-scrape"
          fi
          if [ "${{ github.event.inputs.skip_rescan }}" = "true" ]; then
            FLAGS="$FLAGS --skip-rescan"
          fi
          python weekly_pipeline.py $FLAGS

      - name: Prepare summary for issue
        id: summary
        if: always()
        run: |
          TODAY=$(date +%Y-%m-%d)
          SUMMARY_FILE="data/weekly_logs/weekly_${TODAY}_summary.txt"
          if [ -f "$SUMMARY_FILE" ]; then
            echo "has_summary=true" >> $GITHUB_OUTPUT
            echo "title=PM Pipeline Report: ${TODAY}" >> $GITHUB_OUTPUT
            {
              echo '```'
              cat "$SUMMARY_FILE"
              echo '```'
              echo ""
              echo "**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              echo "**Status:** ${{ steps.pipeline.outcome }}"
            } > pipeline_summary.md
          else
            echo "has_summary=false" >> $GITHUB_OUTPUT
          fi

      - name: Create summary issue
        if: steps.summary.outputs.has_summary == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: ${{ steps.summary.outputs.title }}
          content-filepath: ./pipeline_summary.md
          labels: |
            automated
            pm-pipeline

      - name: Read pipeline state for commit message
        id: state
        run: |
          CHUNK_INFO=$(python -c "
          import json, os
          state_path = 'data/pipeline_state.json'
          if os.path.exists(state_path):
              with open(state_path) as f:
                  s = json.load(f)
              print(f'chunk {s[\"last_chunk_index\"]}/{s[\"total_chunks\"]}')
          else:
              print('no state')
          ")
          echo "chunk_info=$CHUNK_INFO" >> $GITHUB_OUTPUT

          echo "today=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

          # Check if rotation summary exists (rotation completed)
          if [ -f "data/rotation_summary.md" ]; then
            echo "rotation_complete=true" >> $GITHUB_OUTPUT
          else
            echo "rotation_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: changes
        run: |
          # Clean up temp file before staging
          rm -f pipeline_summary.md
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Daily pipeline: $(date +%Y-%m-%d) - ${{ steps.state.outputs.chunk_info }}"
          git push

      - name: Create rotation report issue
        if: steps.state.outputs.rotation_complete == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "PM Detection Rotation Report - ${{ steps.state.outputs.today }}"
          content-filepath: data/rotation_summary.md
          labels: |
            automated
            pm-detection

      - name: Fail if pipeline failed
        if: steps.pipeline.outcome == 'failure'
        run: |
          echo "Pipeline step failed but changes were committed. Check logs above."
          exit 1
